mailster=function(p,c,f,o){"use strict";var m=c(".import-status"),l=c(".export-status"),h=c("#progress"),g=h.find(".bar"),e=c("#mailster_nonce").val(),t=null,s=0,b,i,n=function(){var r=new plupload.Uploader(wpUploaderInit);r.bind("Init",function(e){var t=c("#plupload-upload-ui");if(e.features.dragdrop&&!c(o.body).hasClass("mobile")){t.addClass("drag-drop");c("#drag-drop-area").bind("dragover.wp-uploader",function(){t.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){t.removeClass("drag-over")})}else{t.removeClass("drag-drop");c("#drag-drop-area").unbind(".wp-uploader")}if(e.runtime=="html4")c(".upload-flash-bypass").hide()});r.bind("FilesAdded",function(e,t){c("#media-upload-error").html("");c("#wordpress-users").fadeOut();setTimeout(function(){e.refresh();e.start()},1)});r.bind("BeforeUpload",function(e,t){h.removeClass("finished error hidden");m.html("uploading")});r.bind("UploadFile",function(e,t){});r.bind("UploadProgress",function(e,t){m.html(p.util.sprintf(p.l10n.manage.uploading,t.percent+"%"));g.stop().animate({width:t.percent+"%"},100)});r.bind("Error",function(e,t){m.html(t.message);h.addClass("error");e.refresh()});r.bind("FileUploaded",function(e,t,n){n=JSON.parse(n.response);i=n.identifier;if(!n.success){m.html(n.message);h.addClass("error");e.refresh();r.unbind("UploadComplete")}});r.bind("UploadComplete",function(e,t){m.html(p.l10n.manage.prepare_data);h.addClass("finished");a()});r.init()};typeof wpUploaderInit=="object"&&p.events.push("documentReady",n);c(".wrap").on("change","#signup",function(){c("#signupdate").prop("disabled",!c(this).is(":checked"))}).on("click",".do-import",function(){var e=c("#lists").serialize(),t=c("#subscriber-table").serialize();if(!/%5D=email/.test(t)){alert(p.l10n.manage.select_emailcolumn);return false}if(!c('input[name="status"]:checked').length){alert(p.l10n.manage.select_status);return false}if(!confirm(p.l10n.manage.confirm_import))return false;var n=c(this).prop("disabled",true),r=c('input[name="status"]:checked').val(),i=c('input[name="existing"]:checked').val(),a=c("#signup").is(":checked"),s=c("#signupdate").val(),o=c("#keepstatus").is(":checked"),l=c("#import-ajax-loading").css({display:"inline-block"}),d=c("#identifier").val(),u=c("#performance").is(":checked");h.removeClass("hidden");g.stop().width(0);c(".step1").slideUp();c(".step2-body").html("<br><br>").parent().show();b=new Date;v(0,{identifier:d,order:t,lists:e,status:r,keepstatus:o,existing:i,signupdate:a?s:null,performance:u});m.html(p.l10n.manage.prepare_import);f.onbeforeunload=function(){return p.l10n.manage.onbeforeunloadimport}}).on("change",".wordpress-users-toggle",function(){c(this).parent().parent().parent().find("li input").prop("checked",c(this).prop("checked"))}).on("click","#addlist",function(){var e=c("#new_list_name").val();if(!e)return false;c('<li><label><input name="lists[]" value="'+e+'" type="checkbox" checked> '+e+" </label></li>").appendTo("#lists > ul");c("#new_list_name").val("")}).on("change",".list-toggle",function(){c(this).parent().parent().parent().find("ul input").prop("checked",c(this).prop("checked"))}).on("change",'input[name="status"]',function(){if(c(this).val()<=0){c(".pending-info").show()}else{c(".pending-info").hide()}});c("#paste-import").on("focus",function(){c(this).val("").addClass("focus")}).on("blur",function(){c(this).removeClass("focus");var e=p.util.trim(c(this).val());if(e){p.util.ajax("import_subscribers_upload_handler",{data:e},function(e){if(e.success){i=e.identifier;c("#wordpress-users").fadeOut();a()}else{m.html(e.message);h.addClass("error")}},function(){m.html("Error")})}});c("#import_wordpress").on("submit",function(){var e=c(this).serialize();p.util.ajax("import_subscribers_upload_handler",{wordpressusers:e},function(e){if(e.success){i=e.identifier;c("#wordpress-users").fadeOut();a()}else{m.html(e.message);h.addClass("error")}},function(){m.html("Error")});return false});c('select[name="outputformat"]').on("change",function(){c("#csv-separator")[c(this).val()=="csv"?"show":"hide"]()});p.events.push("documentReady",function(){c.fn.sortable&&c(".export-order").sortable({connectWith:".export-order",_placeholder:"ui-state-highlight",containment:".export-order-wrap",receive:function(e,t){t.item.find("input").prop("checked",t.item.closest(".export-order").is(".selected"))}}).on("change","input",function(){var e=c(this);e.parent().appendTo(e.is(":checked")?c(".export-order.selected"):c(".export-order.unselected"))})});c(".export-order-wrap").on("click",".export-order-add",function(){c(".export-order.unselected").find("li").appendTo(".export-order.selected").find("input").prop("checked",true);return false}).on("click",".export-order-remove",function(){c(".export-order.selected").find("li").appendTo(".export-order.unselected").find("input").prop("checked",false);return false});c("#export-subscribers").on("submit",function(){var n=c(this).serialize();p.util.ajax("export_contacts",{data:n},function(e){if(e.success){f.onbeforeunload=function(){return p.l10n.manage.onbeforeunloadexport};var t=c(".performance").val();c(".step2").slideDown();c(".step2-body").html(p.util.sprintf(p.l10n.manage.write_file,"0.00 Kb"));h.removeClass("finished error hidden");g.stop().width(0);d(0,t,e.count,n)}else{alert(e.msg)}},function(e,t,n){alert(t)});return false});c("#delete-subscribers").on("submit",function(){var e=prompt(p.l10n.manage.confirm_delete,"");if(!e)return false;if("delete"==e.toLowerCase()){var t=c(this).serialize();h.removeClass("finished error hidden");g.stop().animate({width:"99%"},25e3);p.util.ajax("delete_contacts",{data:t},function(e){if(e.success){g.stop().animate({width:"100%"},200,function(){c(".delete-status").html(e.msg);h.addClass("finished")})}else{g.stop();c(".delete-status").html(e.msg);h.addClass("error")}},function(e,t,n){g.stop();c(".delete-status").html("["+e.status+"] "+n);h.addClass("error")})}return false});c("#delete-subscribers").on("change","input, select",r);r();function r(){setTimeout(function(){var e=c("#delete-subscribers").serialize();c("#delete-subscriber-button").prop("disabled",true);p.util.ajax("get_subscriber_count",{data:e},function(e){if(e.success){c("#delete-subscriber-button").val(p.util.sprintf(p.l10n.manage.delete_n_subscribers,e.count)).prop("disabled",!e.count)}})},10)}c("input.selectall").on("change",function(){var e=c(this),t=e.attr("name");c('input[name="'+t+'"]').prop("checked",e.prop("checked"))});function d(n,r,i,a){var e=(new Date).getTime(),s=Math.min(1,r*n/i)*100;l.html(p.util.sprintf(p.l10n.manage.prepare_download,i,""));p.util.ajax("do_export",{limit:r,offset:n,data:a},function(e){var t=s>=100&&e.finished;if(e.success){if(!t)d(n+1,r,i,a);g.animate({width:s+"%"},{duration:1e3,easing:"swing",queue:false,step:function(e){l.html(p.util.sprintf(p.l10n.manage.prepare_download,i,Math.ceil(e)+"%"))},complete:function(){l.html(p.util.sprintf(p.l10n.manage.prepare_download,i,Math.ceil(s)+"%"));if(t){f.onbeforeunload=null;h.addClass("finished");c(".step2-body").html(p.l10n.manage.export_finished);l.html(p.util.sprintf(p.l10n.manage.downloading,i));if(e.filename)setTimeout(function(){o.location=e.filename},1e3)}else{c(".step2-body").html(p.util.sprintf(p.l10n.manage.write_file,e.total))}}})}else{g.stop();h.addClass("error");f.onbeforeunload=null;l.html(p.l10n.manage.error_export);c(".step2-body").html(e.msg)}},function(e,t,n){})}function v(r,i){var a=0;if(!r)r=0;p.util.ajax("do_import",{id:r,options:i},function(e){a=Math.min(1,(e.imported+e.errors)/e.total)*100;c(".step2-body").html("<p>"+w(e.f_imported,e.f_errors,e.f_total,a,e.memoryusage)+"</p>");s=0;var t=a>=100;if(e.success){if(!t)v(r+1,i);g.animate({width:a+"%"},{duration:1e3,easing:"swing",queue:false,step:function(e){m.html(p.util.sprintf(p.l10n.manage.import_contacts,Math.ceil(e)+"%"))},complete:function(){m.html(p.util.sprintf(p.l10n.manage.import_contacts,Math.ceil(a)+"%"));if(t){f.onbeforeunload=null;h.addClass("finished");c(".step2-body").html(e.html).slideDown()}}})}else{u(a,r,i)}},function(e,t,n){u(a,r,i)})}function a(){h.removeClass("finished error");p.util.ajax("get_import_data",{identifier:i},function(e){h.addClass("hidden");c(".step1").slideUp();c(".step2-body").html(e.html).parent().show();c("input.datepicker").datepicker({dateFormat:"yy-mm-dd",showAnim:"fadeIn",onClose:function(){}});m.html("");t=e.data})}function u(e,t,n){s++;if(s>=5){alert(p.l10n.manage.error_importing);f.onbeforeunload=null;return}var r=s*5,i="",a=setInterval(function(){if(r<=0){clearInterval(a);h.removeClass("paused");v(t,n);i=Math.round(e)+"%"}else{h.addClass("paused");i='<span class="error">'+p.util.sprintf(p.l10n.manage.continues_in,r--)+"</span>"}m.html(p.util.sprintf(p.l10n.manage.import_contacts,i))},1e3)}function w(e,t,n,r,i){var a=(new Date).getTime()-b.getTime(),s=Math.ceil((100-r)*(a/r)/6e4);return p.util.sprintf(p.l10n.manage.current_stats,"<strong>"+e+"</strong>","<strong>"+n+"</strong>","<strong>"+t+"</strong>","<strong>"+i+"</strong>")+"<br>"+p.util.sprintf(p.l10n.manage.estimate_time,s)}return p}(mailster||{},jQuery,window,document);