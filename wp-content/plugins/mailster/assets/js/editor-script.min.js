if(parent.window===window){var campaign_id;if(campaign_id=location.search.match(/id=(\d+)/i)[1]){window.location=location.protocol+"//"+location.host+location.pathname.replace("admin-ajax.php","post.php")+"?post="+campaign_id+"&action=edit"}}document.getElementsByTagName("html")[0].className+=" mailster-loading";window.mailster=parent.window.mailster||{};mailster=function(d,s,e,t){"use strict";d.editor=d.editor||{};d.editor.loaded=false;d.editor.$=d.editor.$||{};d.editor.$.html=s("html");d.editor.$.body=s("body");s(e).on("load",function(){d.editor.updateElements();d.editor.$.html.removeClass("mailster-loading");d.editor.$.body.on("click","a",function(e){e.preventDefault()}).on("click",function(e){d.modules.selected&&d.modules.selected.removeAttr("selected")}).on("click","module",function(e){if("MODULE"==e.target.nodeName){var t=s(this);e.stopPropagation();if(d.modules.selected[0]!=t[0]){d.trigger("selectModule",t)}}}).on("click","button.addbutton",function(){var e=s(this).data(),t=decodeURIComponent(e.element.data("tmpl"))||'<a href="" editable label="Button"></a>';d.editbar.open({type:"btn",offset:e.offset,element:s(t).attr("tmpbutton","").appendTo(e.element),name:e.name});return false}).on("click","button.addrepeater",function(){var e=s(this).data();if("TH"==e.element[0].nodeName||"TD"==e.element[0].nodeName){var t=e.element.closest("table"),i=e.element.prevAll().length;for(var a=t[0].rows.length-1;a>=0;a--){s(t[0].rows[a].cells[i]).clone().insertAfter(t[0].rows[a].cells[i])}}else{e.element.clone().insertAfter(e.element)}d.trigger("save");d.trigger("refresh");return false}).on("click","button.removerepeater",function(){var e=s(this).data();if("TH"==e.element[0].nodeName||"TD"==e.element[0].nodeName){var t=e.element.closest("table"),i=e.element.prevAll().length;for(var a=t[0].rows.length-1;a>=0;a--){s(t[0].rows[a].cells[i]).remove()}}else{e.element.remove()}d.trigger("save");d.trigger("refresh");return false});if(!d.editor.loaded){d.editor.loaded=true;d.trigger("editorLoaded")}});d.editor.getFrameContent=function(){if(!d.editor.$.body.length){return false}var e=d.editor.$.body[0],t,i,a,r,o="";t=s("<div>"+e.innerHTML+"</div>");t.find(".mce-tinymce, .mce-widget, .mce-toolbar-grp, .mce-container, .screen-reader-text, .ui-helper-hidden-accessible, .wplink-autocomplete, modulebuttons, mailster, #mailster-editorimage-upload-button, button, .a11y-speak-intro-text").remove();t.find("single, multi, module, modules, buttons").removeAttr("contenteditable spellcheck id dir style class selected");i=d.util.trim(t.html().replace(/\u200c/g,"&zwnj;").replace(/\u200d/g,"&zwj;"));a=e.attributes||[];r=a.length;if(r){while(r--){o=" "+a[r].name+'="'+d.util.trim(a[r].value)+'"'+o}}o=d.util.trim(o.replace(/(webkit |wp\-editor|mceContentBody|position: relative;|cursor: auto;|modal-open| spellcheck="(true|false)")/g,"").replace(/(class="(\s*)"|style="(\s*)")/g,""));return d.$.head.val()+"\n<body"+(o?" "+o:"")+">\n"+i+"\n</body>\n</html>"};d.editor.cleanup=function(){d.editor.$.document.find("#a11y-speak-assertive, #a11y-speak-polite, #droplr-chrome-extension-is-installed").remove()};d.editor.getStructure=function(e){var t=e.match(/([^]*)<body([^>]*)?>([^]*)<\/body>([^]*)/m);return{parts:t?t:["","","","<multi>"+e+"</multi>"],content:t?t[3]:"<multi>"+e+"</multi>",head:t?d.util.trim(t[1]):"",bodyattributes:t?s("<div"+(t[2]||"")+"></div>")[0].attributes:""}};d.editor.getContent=function(){return d.$.content.val()||d.editor.getFrameContent()};d.editor.setContent=function(e,t,i,a){var r=d.editor.getStructure(e),o=r.bodyattributes.length,n=d.editor.$.document.find("head"),l=n.find("link");d.$.head.val(r.head);if(!a){a=""}n[0].innerHTML=r.head.replace(/([^]*)<head([^>]*)?>([^]*)<\/head>([^]*)/m,"$3"+a);n.append(l);d.editor.$.body[0].innerHTML=r.content;if(o){while(o--){d.editor.$.body[0].setAttribute(r.bodyattributes[o].name,r.bodyattributes[o].value)}}d.$.content.val(e);if(typeof i=="undefined"||i===true){d.trigger("save")}setTimeout(function(){d.trigger("redraw")},100)};d.editor.getHeight=function(){return Math.max(500,d.editor.$.body.outerHeight())};d.editor.resize=function(){if(!d.editor.loaded)return false;setTimeout(function(){d.$.iframe.attr("height",d.editor.getHeight());d.trigger("resize")},50)};d.editor.colors=d.$.options.find(".colors").data();function i(){d.$.templateWrap.removeClass("load");d.trigger("iframeLoaded");a()}function a(){d.editor.$.document.find(".content.mailster-btn").remove();var l=null;if(!d.editor.$.document)return;d.editor.$.document.on("click.mailster","img[editable]",function(e){e.stopPropagation();var t=s(this),i=t.offset(),a=i.top+61,r=i.left,o=t.attr("label"),n="img";d.editbar.open({offset:i,type:n,name:o,element:t})}).on("click.mailster","module td[background],module th[background]",function(e){e.stopPropagation();l=true}).on("click.mailster","td[background], th[background]",function(e){e.stopPropagation();if(!l&&e.target!=this)return;l=null;var t=s(this),i=t.offset(),a=i.top+61,r=i.left,o=t.attr("label"),n="img";d.editbar.open({offset:i,type:n,name:o,element:t})}).on("click.mailster","a[editable]",function(e){e.stopPropagation();e.preventDefault();var t=s(this),i=t.offset(),a=i.top+40,r=i.left,o=t.attr("label"),n="btn";d.editbar.open({offset:i,type:n,name:o,element:t})});if(!mailsterdata.inline){d.editor.$.container.on("click.mailster","multi, single",function(e){e.stopPropagation();var t=s(this),i=t.offset(),a=i.top+40,r=i.left,o=t.attr("label"),n=t.prop("tagName").toLowerCase();d.editbar.open({offset:i,type:n,name:o,element:t})})}d.editor.cleanup()}d.events=d.events||[];d.events.push("refresh",d.editor.resize);d.events.push("editorLoaded",i,d.editor.resize);d.events.push("redraw",a);d.editor.$.body.find("div.modulebuttons").remove();d.isrtl?d.editor.$.html.attr("mailster-is-rtl",""):d.editor.$.html.removeAttr("mailster-is-rtl");return d}(mailster||{},jQuery,window,document);mailster=function(c,f,p,e){"use strict";var t,o=false,g=false;c.events=c.events||[];c.events.push("editorLoaded",function(){c.events.push("refresh",i,r,n);r();n();c.events.push("resize",l)&&l();c.events.push("selectModule",d);typeof mOxie!="undefined"&&c.events.push("refresh",s)&&s();typeof tinymce!="undefined"&&c.events.push("refresh",u)&&u()});f(e).ready(i);function i(){c.editor.$=c.editor.$||{};c.editor.$.document=f(e);c.editor.$.window=f(p);c.editor.$.html=f("html");c.editor.$.body=f("body");c.editor.$.container=f("modules");c.editor.$.modules=f("module");c.editor.$.images=f("img[editable]");c.editor.$.buttons=f("buttons");c.editor.$.repeatable=f("[repeatable]")}function a(){var e=f(mailsterdata.modules).add(c.editor.$.modules),o=0;if(!c.editor.$.modules.length){return}e=c.editor.$.modules;f.each(e,function(e){var t=f(this);if(t.is("module")&&!t.find("modulebuttons").length){var i=t.attr("label")||c.util.sprintf(c.l10n.campaigns.module,"#"+ ++o),a=mailsterdata.codeview?'<button class="mailster-btn codeview" title="'+c.l10n.campaigns.codeview+'"></button>':"",r=t.is("[auto]")?'<button class="mailster-btn auto" title="'+c.l10n.campaigns.auto+'"></button>':"";f("<modulebuttons>"+'<input class="modulelabel" type="text" value="'+i+'" placeholder="'+i+'" title="'+c.l10n.campaigns.module_label+'" tabindex="-1"><span>'+r+'<button class="mailster-btn duplicate" title="'+c.l10n.campaigns.duplicate_module+'"></button><button class="mailster-btn up" title="'+c.l10n.campaigns.move_module_up+'"></button><button class="mailster-btn down" title="'+c.l10n.campaigns.move_module_down+'"></button>'+a+'<button class="mailster-btn remove" title="'+c.l10n.campaigns.remove_module+'"></button></span></modulebuttons>').prependTo(t)}})}function r(){if(c.editor.$.container.data("sortable"))c.editor.$.container.sortable("destroy");if(c.editor.$.modules.length<2)return;c.editor.$.container.sortable({stop:function(e,t){e.stopPropagation();c.editor.$.container.removeClass("dragging");setTimeout(function(){c.trigger("refresh");c.trigger("save")},200)},start:function(e,t){e.stopPropagation();c.editor.$.container.addClass("dragging")},containment:"body",revert:100,axis:"y",placeholder:"sortable-placeholder",items:"> module",delay:20,distance:5,scroll:true,scrollSensitivity:10,forcePlaceholderSize:true,helper:"clone",zIndex:1e4})}function n(){if(c.editor.$.images.data("draggable"))c.editor.$.images.draggable("destroy");if(c.editor.$.images.data("droppable"))c.editor.$.images.droppable("destroy");c.editor.$.images.draggable({helper:"clone",scroll:true,scrollSensitivity:10,opacity:.7,zIndex:1e3,revert:"invalid",addClasses:false,create:function(e,t){f(e.target).removeClass("ui-draggable-handle")},start:function(){c.editor.$.body.addClass("ui-dragging")},stop:function(){c.editor.$.body.removeClass("ui-dragging");c.trigger("refresh")}}).droppable({addClasses:false,over:function(e,t){f(e.target).addClass("ui-drag-over")},out:function(e,t){f(e.target).removeClass("ui-drag-over")},drop:function(n,e){var l=f(e.draggable[0]),d=f(n.target),s,u,t,m;d.removeClass("ui-drag-over");if(!l.is("img")||!d.is("img"))return;s=d.attr("data-id")?parseInt(d.attr("data-id"),10):null;u=l.attr("data-id")?parseInt(l.attr("data-id"),10):null;t=l.data("crop");m=l.clone();l.addClass("mailster-loading");d.addClass("mailster-loading");c.util.getRealDimensions(l,function(a,r,o){c.util.getRealDimensions(d,function(e,t,i){if(n.altKey){l.removeClass("mailster-loading");d.removeClass("mailster-loading")}else if(s){c.util.ajax("create_image",{id:s,width:a,height:r,crop:l.data("crop")},function(e){l.removeAttr("src").attr({"data-id":s,title:d.attr("title"),alt:d.attr("alt"),src:e.image.url,width:Math.round(e.image.width/o),height:Math.round(e.image.height/o)}).data("id",s).removeClass("mailster-loading")},function(e,t,i){alert(t+" "+e.status+": "+i+"\n\nCheck the JS console for more info!")})}else{l.removeAttr("src").attr({"data-id":0,title:d.attr("title"),alt:d.attr("alt"),src:d.attr("src"),width:Math.round(a/o),height:Math.round(a/(e/t)/o)}).data("id",0).removeClass("mailster-loading")}if(u){c.util.ajax("create_image",{id:u,width:e,height:t,crop:d.data("crop")},function(e){d.removeAttr("src").attr({"data-id":u,title:l.attr("title"),alt:l.attr("alt"),src:e.image.url,width:Math.round(e.image.width/i),height:Math.round(e.image.height/i)}).data("id",u).removeClass("mailster-loading");c.trigger("refresh")},function(e,t,i){alert(t+" "+e.status+": "+i+"\n\nCheck the JS console for more info!")})}else{d.removeAttr("src").attr({"data-id":0,title:m.attr("title"),alt:m.attr("alt"),src:m.attr("src"),width:Math.round(e/i),height:Math.round(e/(a/r)/i)}).data("id",0).removeClass("mailster-loading")}if(!u&&!s)c.trigger("refresh")})})}})}function l(){if(c.editor.$.buttons){f.each(c.editor.$.buttons,function(){var e=f(this),t=e.attr("label"),i=this.getBoundingClientRect(),a=i.top+0,r=i.right+0,o,n;if(e.data("has-buttons"))return;o=f('<button class="addbutton mailster-btn mailster-btn-inline" title="'+c.l10n.campaigns.add_button+'"></button>').appendTo(e);o.data("offset",i).data("name",t);o.data("element",e);e.data("has-buttons",true);if(!(n=e.data("tmpl"))){if(e.find(".textbutton").length){n=e.find(".textbutton").last()}else if(e.find("img").length){n=e.find("a[editable]").last()}else{n=f('<a href="" editable label="Button"></a>')}n=f("<div/>").text(encodeURIComponent(n[0].outerHTML)).html()}e.attr("data-tmpl",n).data("tmpl",n)})}f("button.addrepeater, button.removerepeater").remove();if(c.editor.$.repeatable){f.each(c.editor.$.repeatable,function(){var e=f(this),t=e.closest("module"),i=e.attr("label"),a=t[0].getBoundingClientRect(),r=this.getBoundingClientRect(),o=r.top-a.top,n=r.left,l=r.top-a.top+18,d=r.left,s;if("TH"==this.nodeName||"TD"==this.nodeName){o=0;n=r.width-36;l=0;d=r.width-18}s=f('<button class="addrepeater mailster-btn mailster-btn-inline" title="'+c.l10n.campaigns.add_repeater+'"></button>').css({top:o,left:n}).appendTo(e);s.data("offset",r).data("name",i);s.data("element",e);s=f('<button class="removerepeater mailster-btn mailster-btn-inline" title="'+c.l10n.campaigns.remove_repeater+'"></button>').css({top:l,left:d}).appendTo(e);s.data("offset",r).data("name",i);s.data("element",e)})}}function d(e){if(!e.length){return}if(c.modules.selected){c.modules.selected.removeAttr("selected")}c.modules.selected=e;c.modules.selected.attr("selected",true)}function s(){f.each(c.editor.$.images,function(){var u=f(this),m;if(u.data("has-dropzone"))return;m=new mOxie.FileDrop({drop_zone:this});m.ondrop=function(e){if(c.modules.dragging)return;u.removeClass("ui-drag-over-file ui-drag-over-file-alt");var t=m.files.shift(),i=p.event&&event.altKey,a=[u.width(),u.height()],r=u.data("crop"),o=u.offset(),n=f('<upload><div class="mailster-upload-info"><div class="mailster-upload-info-bar"></div><div class="mailster-upload-info-text"></div></div></upload>'),l=n.find(".mailster-upload-info-bar"),d=n.find(".mailster-upload-info-text"),s=new mOxie.Image(t);s.onerror=function(e){alert(c.l10n.campaigns.unsupported_format)};s.onload=function(e){n.insertAfter(u);u.appendTo(n);t._element=u;t._altKey=i;t._crop=r;t._upload=n;t._preview=l;t._previewtext=d;t._dimensions=[s.width,s.height,s.width/s.height];s.downsize(a[0],a[1]);l.css({"background-image":"url("+s.getAsDataURL()+")","background-size":a[0]+"px "+(r?a[1]:a[0]/t._dimensions[2])+"px"});g.addFile(t)};s.load(t)};m.ondragenter=function(e){if(c.modules.dragging)return;u.addClass("ui-drag-over-file");if(p.event&&event.altKey)u.addClass("ui-drag-over-file-alt")};m.ondragleave=function(e){if(c.modules.dragging)return;u.removeClass("ui-drag-over-file ui-drag-over-file-alt")};m.onerror=function(e){if(c.modules.dragging)return;u.removeClass("ui-drag-over-file ui-drag-over-file-alt")};m.init();u.data("has-dropzone",true)});if(!g){f('<button id="mailster-editorimage-upload-button" />').hide().appendTo("mailster");g=new plupload.Uploader(mailsterdata.plupload);g.bind("Init",function(e){f(".moxie-shim").remove()});g.bind("FilesAdded",function(a,e){var r=e[0].getSource();c.util.getRealDimensions(r._element,function(e,t,i){a.settings.multipart_params.width=e;a.settings.multipart_params.height=t;a.settings.multipart_params.factor=i;a.settings.multipart_params.crop=r._crop;a.settings.multipart_params.altKey=r._altKey;a.refresh();a.start()})});g.bind("BeforeUpload",function(e,t){});g.bind("UploadFile",function(e,t){});g.bind("UploadProgress",function(e,t){var i=t.getSource();i._preview.width(t.percent+"%");i._previewtext.html(t.percent+"%")});g.bind("Error",function(e,t){var i=t.file.getSource();alert(t.message);i._element.insertAfter(i._upload);i._upload.remove()});g.bind("FileUploaded",function(e,t,i){var a=t.getSource(),r,o;try{i=JSON.parse(i.response);a._previewtext.html(c.l10n.campaigns.ready);a._element.on("load",function(){clearTimeout(r);a._preview.fadeOut(function(){a._element.insertAfter(a._upload);a._upload.remove();c.trigger("refresh")})});o=Math.round(a._element.width()/i.image.asp);a._element.attr({src:i.image.url,alt:i.name,height:o,"data-id":i.image.id||0}).data("id",i.image.id||0);a._preview.height(o);r=setTimeout(function(){a._preview.fadeOut(function(){a._element.insertAfter(a._upload);a._upload.remove();c.trigger("refresh")})},3e3)}catch(e){a._preview.addClass("error").find(".mailster-upload-info-text").html(c.l10n.campaigns.error);alert(c.l10n.campaigns.error_occurs+"\n"+e.message);a._preview.fadeOut(function(){a._element.insertAfter(a._upload);a._upload.remove()})}});g.bind("UploadComplete",function(e,t){});g.init()}}function u(){tinymce.init(f.extend(mailsterdata.tinymce.args,mailsterdata.tinymce.multi,{paste_preprocess:m,urlconverter_callback:v,setup:h}));tinymce.init(f.extend(mailsterdata.tinymce.args,mailsterdata.tinymce.single,{paste_preprocess:m,urlconverter_callback:v,setup:h}))}function m(e,t){var i=t.content,a="<a><br><i><em><u><p><h1><h2><h3><h4><h5><h6><ul><ol><li>",r="",o=false,n=[],l=[],d="",s=0,u="",m="",c=function(e,t,i){return i.split(e).join(t)};if(a){l=a.match(/([a-zA-Z0-9]+)/gi)}i+="";n=i.match(/(<\/?[\S][^>]*>)/gi);for(r in n){if(isNaN(r)){continue}m=n[r].toString();o=false;for(u in l){d=l[u];s=-1;if(s!=0){s=m.toLowerCase().indexOf("<"+d+">")}if(s!=0){s=m.toLowerCase().indexOf("<"+d+" ")}if(s!=0){s=m.toLowerCase().indexOf("</"+d)}if(s==0){o=true;break}}if(!o){i=c(m,"",i)}}t.content=i;return i}function h(a){a.addButton("mailster_mce_button",{title:mailster_mce_button.l10n.tags.title,type:"menubutton",icon:"icon mailster-tags-icon",menu:f.map(mailster_mce_button.tags,function(e,t){return{text:e.name,menu:f.map(e.tags,function(e,i){return{text:e,onclick:function(){var e="",t;switch(i){case"webversion":case"unsub":case"forward":case"profile":e="link";case"homepage":if(t=a.selection.getContent({format:"text"})){a.insertContent('<a href="{'+i+e+'}">'+t+"</a>");break}default:a.insertContent("{"+i+"} ")}}}})}})});a.addButton("mailster_remove_element",{title:mailster_mce_button.l10n.remove.title,icon:"icon mailster-remove-icon",onclick:function(){a.targetElm.remove();a.remove();c.trigger("save")}});a.on("change",function(a){var r=this;clearTimeout(t);t=setTimeout(function(){var e=a.level.content,t=e.match(/rgb\((\d+), ?(\d+), ?(\d+)\)/g);if(t){for(var i=t.length-1;i>=0;i--){e=e.replace(t[i],c.util.rgb2hex(t[i]))}r.bodyElement.innerHTML=e}c.trigger("save");o=true},100)}).on("keyup",function(e){f(e.currentTarget).prop("spellcheck",true)}).on("click",function(e){var t=f(e.currentTarget).closest("module");if(c.modules.selected[0]!=t[0]){c.trigger("selectModule",t)}e.stopPropagation();a.focus()}).on("focus",function(e){e.stopPropagation();a.selection.select(a.getBody(),true);if(c.editor.$.container.data("uiSortable"))c.editor.$.container.sortable("destroy")}).on("blur",function(e){c.trigger("refresh")})}function v(e,t,i,a){if("_wp_link_placeholder"==e){return e}else if(/^https?:\/\/{.+}/g.test(e)){return e.replace(/^https?:\/\//,"")}else if(/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(e)){return"mailto:"+e}return this.documentBaseURI.toAbsolute(e,mailsterdata.tinymce.remove_script_host)}c.editor.updateElements=i;c.editor.moduleButtons=a;c.events.push("editorLoaded",i,a);c.events.push("redraw",i,a);return c}(mailster||{},jQuery,window,document);parent.window.mailster=mailster;