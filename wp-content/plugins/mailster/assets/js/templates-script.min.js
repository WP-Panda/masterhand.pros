mailster=function(e,t,a,l){"use strict";var i=t("#mailster_iframe"),s=i.data("base"),n=t("#templateeditor"),o=t("textarea.editor"),r=t(".uploadinfo"),d;t(".upload-template").on("click",function(){t(".upload-field").show()});t("#mailster_templates").on("click",".screenshot a",function(e){e.stopPropagation()}).on("click",".edit",function(){var a=t(this),l=a.closest(".mailster-box"),i=t(".mailster-box"),s=a.attr("href"),o=a.data("slug");if(a.parent().hasClass("disabled"))return false;i.removeClass("edit");l.addClass("edit");var r=l.data("id");var d=Math.floor(t("#mailster_templates").outerWidth()/(l.width()+22));var c=Math.floor(r/d)*d+d-1;n.find("textarea").val("");n.find("h3").html(l.find("h3").html());n.slideDown();n.insertAfter(i.eq(c).length?i.eq(c):i.last());e.util.scroll(n.offset().top-50);l.removeClass("loading");f(s);return false}).on("change",".template-file-selector-dd",function(){f(t(this).val())}).on("click",".remove-file",function(){var a=t(this);if(confirm(a.data("confirm"))){t("#templateeditor").addClass("loading");e.util.ajax("remove_template",{file:a.data("file")},function(e){t("#templateeditor").removeClass("loading");if(e.success){t(".template-file-selector-dd").find(":selected").prev("option").prop("selected",true).trigger("change")}})}event.stopPropagation();return false}).on("click","a.cancel",function(){n.slideUp();t(".mailster-box").removeClass("edit");return false}).on("click","button.save, button.saveas",function(){var a=t(this),l=t(".template-ajax-loading"),i=d.getValue(),s=t("span.message"),n;if(a.is(".saveas")&&!(n=prompt(e.l10n.templates.enter_template_name+":","")))return false;l.css({display:"inline"});a.prop("disabled",true);e.util.ajax("set_template_html",{content:i,name:n,slug:t("#slug").val(),file:t("#file").val()},function(e){l.hide();a.prop("disabled",false);if(e.success){s.fadeIn(10).html(e.msg).delay(2e3).fadeOut();if(e.newfile){f("mailster/"+e.newfile)}}else{alert(e.msg)}},function(e,t,i){l.hide();a.prop("disabled",false);alert(t+" "+e.status+": "+i+"\n\nCheck the JS console for more info!")});return false}).on("click",".thickbox-preview",function(){var a=t(this),l=a.parent().attr("title"),i=a.data("slug"),s=a.attr("href");t("#thickboxbox").find("iframe").attr("src",s);t(".thickbox-filelist").empty().hide();tb_show(l,"?&width=900&inlineId=thickboxbox&TB_inline",null);t("#TB_window").width(936).height(700).css("margin-left",-936/2).css("margin-top",-700/2);e.util.ajax("get_file_list",{slug:i},function(e){if(e.success){var a="";t.each(e.files,function(t,l){a+="<li>";if("index.html"!=t&&"notification.html"!=t){a+='<a href="" class="thickbox-remove-file mailster-icon" data-slug="'+e.slug+'" data-file="'+t+'"></a>'}a+='<a href="'+e.base+"/"+t+'" class="thickbox-file" style="background-image:url('+l.screenshot+')"></a><span>'+l.label+" ("+t+")</span></li>"});t(".thickbox-filelist").html(a).slideDown()}else{alert(e.msg)}},function(e,t,a){loader.hide();$this.prop("disabled",false);alert(t+" "+e.status+": "+a+"\n\nCheck the JS console for more info!")});return false}).on("click","a.activate",function(){var e=t(this),a="",l=e.data("license")||"",i=e.data("slug");t("#template-"+i).addClass("add-license").find(".license").val(l).focus().select();return false}).on("click","a.download",function(){t(this).prop("disabled",true)}).on("click","a.update",function(){if(confirm(e.l10n.templates.update_note)){t(this).closest(".mailster-box").addClass("loading");return true}return false}).on("click","a.deletion",function(){if(confirm(e.util.sprintf(e.l10n.templates.confirm_delete,'"'+t(this).data("name")+'"'))){t(this).closest(".mailster-box").addClass("loading");return true}return false}).on("click","a.download, a.activatelink, .save-license",function(){t(this).closest(".mailster-box").addClass("loading")});e.$.document.on("click","a.thickbox-file",function(){t(".thickbox-iframe").attr("src",t(this).attr("href"));return false}).on("click",".thickbox-remove-file",function(){var a=t(this),l=a.parent(),i=a.data("slug"),s=a.data("file");if(confirm(e.util.sprintf(e.l10n.templates.delete_template_file,s,i))){l.addClass("loading");e.util.ajax("remove_template",{file:i+"/"+s},function(e){if(e.success){l.slideUp()}else{l.removeClass("loading")}})}event.stopPropagation();return false});function c(){var a=new plupload.Uploader(wpUploaderInit);a.bind("Init",function(e){var a=t("#plupload-upload-ui");if(e.features.dragdrop&&!t(l.body).hasClass("mobile")){a.addClass("drag-drop");t("#drag-drop-area").bind("dragover.wp-uploader",function(){a.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){a.removeClass("drag-over")})}else{a.removeClass("drag-drop");t("#drag-drop-area").unbind(".wp-uploader")}if(e.runtime=="html4")t(".upload-flash-bypass").hide()});a.init();a.bind("FilesAdded",function(e,t){setTimeout(function(){e.refresh();e.start()},1)});a.bind("BeforeUpload",function(e,t){});a.bind("UploadFile",function(e,t){});a.bind("UploadProgress",function(t,a){r.html(e.util.sprintf(e.l10n.templates.uploading,a.percent+"%"))});a.bind("Error",function(e,t){r.html(t.message);e.refresh()});a.bind("FileUploaded",function(e,t,a){a=JSON.parse(a.response);if(a.success){location.reload()}else{r.html(a.error)}});a.bind("UploadComplete",function(e,t){})}function f(a){var l=t(".template-ajax-loading").css({display:"inline"});t("#templateeditor").addClass("loading");e.util.ajax("get_template_html",{href:a},function(a){l.hide();t("#templateeditor").removeClass("loading");t("#file").val(a.file);t("#slug").val(a.slug);o.val(a.html);if(!d){var i={name:"htmlmixed",scriptTypes:[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]};d=e.util.CodeMirror.fromTextArea(o.get(0),{mode:i,tabMode:"indent",lineNumbers:true,autofocus:true})}else{d.setValue(a.html)}var s='<select class="template-file-selector-dd">',r=Object.keys(a.files).length,c;t.each(a.files,function(e,l){if(r>1)s+='<optgroup label="'+e+'">';t.each(l,function(e,t){if(e==a.file)c=t;s+=' <option value="'+a.slug+"/"+e+'" '+(e==a.file?"selected":"")+' data-slug="'+a.slug+'">'+t.label+" ("+e+")</option>"});if(r>1)s+="</optgroup>"});s+="</select>";if(a.file!="index.html"&&a.file!="notification.html")s+='<a class="remove-file mailster-icon" data-file="'+a.slug+"/"+a.file+'" data-confirm="'+e.util.sprintf(e.l10n.templates.delete_template_file,c.label,c.name)+'"></a>';n.find(".template-file-selector span").html(s)})}typeof wpUploaderInit=="object"&&e.events.push("documentReady",c);return e}(mailster||{},jQuery,window,document);