mailster=function(e,t,i,a){"use strict";var n={},l=e.$.editbar,r,s={img:0,single:80,multi:0,btn:0,auto:0,codeview:0},o=l.find(".imagepreview"),d=l.find(".imagewidth"),c=l.find(".imageheight"),m=l.find(".imagecrop"),f=l.find(".factor"),h=l.find(".highdpi"),u=l.find(".original"),p=l.find(".imagelink"),g=l.find(".imageurl"),v=l.find(".orgimageurl"),b=l.find(".imagealt"),y=l.find(".singlelink"),_=l.find(".buttonlink"),w=l.find(".buttonlabel"),k=l.find(".buttonalt"),x=l.find(".button-nav"),C=l.find("ul.buttons"),M,q={mode:{name:"htmlmixed",scriptTypes:[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]},tabMode:"indent",lineNumbers:true,viewportMargin:Infinity,autofocus:true},A,j,T,D,N,$,E,I,O,z,R,W,L="",S=t("#post-search"),B=t("#image-search"),H=t('[name="image-search-type"]');l.on("keyup change","input.live",Y).on("keyup change","#mailster-editor",Y).on("click",".replace-image",K).on("change",".highdpi",Q).on("click","button.save",ee).on("click",".cancel",ie).on("click","a.remove",te).on("click","a.reload",de).on("click","a.single-link-content",fe).on("click","a.add_image",pe).on("click","a.add_image_url",ue).on("click",".imagelist li",le).on("dblclick",".imagelist li",ee).on("change","#post_type_select input",de).on("click",".postlist li",se).on("click",".load-more-posts",ce).on("click","a.btnsrc",ae).on("click",".imagepreview",ne).on("click","a.nav-tab",F).on("change","select.check-for-posts",G).on("change paste","#dynamic_rss_url",G).on("keyup change","#post-search",me).on("keyup change","#image-search",me).on("change",'[name="image-search-type"]',me).on("mouseenter","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",J).on("mouseleave","#wp-mailster-editor-wrap, .imagelist, .postlist, .CodeMirror",V).on("click",".current-tag a",false).on("keypress.mailster",function(e){if(e.keyCode==13&&e.target.nodeName.toLowerCase()!="textarea")return false}).on("keyup.mailster",function(e){switch(e.keyCode){case 27:ie();return false;break;case 13:if(j.type!="multi"&&j.type!="codeview"){ee();return false}break}});e.util.getRealDimensions(e.$.iframe.contents().find("img").eq(0),function(e,t,i){var a=i>=1.5;f.val(i);h.prop("checked",a);a?l.addClass("high-dpi"):l.removeClass("high-dpi")});x.on("click","a",function(){t(this).parent().find("a").removeClass("nav-tab-active");t(this).parent().parent().find("ul.buttons").hide();var e=t(this).addClass("nav-tab-active").attr("href");t("#tab-"+e.substr(1)).show();return false});g.on("paste change",function(i){var a=t(this);setTimeout(function(){var t=P(a.val()),n=new Image;if(t){Z();n.onload=function(){o.attr("src",t);c.val(Math.round(n.width/(n.width/n.height)));T={width:n.width,height:n.height,asp:n.width/n.height};Z(false)};n.onerror=function(){if(i.type!="paste")alert(e.util.sprintf(e.l10n.campaigns.invalid_image,'"'+t+'"'))};n.src=t}},1)});d.on("keyup change",function(){if(!m.is(":checked"))c.val(Math.round(d.val()/T.asp));re()});c.on("keyup change",function(){if(!m.is(":checked"))d.val(Math.round(c.val()*T.asp));re()});m.on("change",function(){if(!m.is(":checked")){c.val(Math.round(d.val()/T.asp));m.parent().removeClass("not-cropped")}else{m.parent().addClass("not-cropped")}re()});t("#dynamic_embed_options_post_type").on("change",function(){var i=t("#dynamic_embed_options_cats"),a=t(this).val();i.find("select").prop("disabled",true);l.find(".dynamic-rss")[a=="rss"?"show":"hide"]();Z();e.util.ajax("get_post_term_dropdown",{posttype:a},function(a){Z(false);if(a.success){i.html(a.html);if(N&&N.terms){var n=i.find(".dynamic_embed_options_taxonomy_wrap");t.each(N.terms,function(i,a){if(!a)return;var l=a.split(",");t.each(l,function(a,l){var r=n.eq(i).find("select").eq(a),s;if(!r.length){s=n.eq(i).find("select").last();r=s.clone();r.insertAfter(s);t("<span> "+e.l10n.campaigns.or+" </span>").insertBefore(r)}r.val(l)})})}}G()},function(e,t,i){Z(false)})});e.events.documentReady.push(function(){l.draggable&&l.draggable({distance:20,axis:"y"});if(e.util.isTinyMCE&&tinymce.get("mailster-editor")){if(tinymce.majorVersion>=4){tinymce.get("mailster-editor").on("keyup",function(){ge(this)});tinymce.get("mailster-editor").on("ExecCommand",function(){ge(this)})}else{tinymce.get("mailster-editor").onKeyUp.add(function(){ge(this)});tinymce.get("mailster-editor").onExecCommand.add(function(){ge(this)})}}});function J(){U(false)}function V(){U(true)}function U(e){if(l.draggable){if(e!==false){l.draggable("enable")}else{l.draggable("disable")}}}function F(e,i){var a;if(typeof e=="string"){a=r.find('a[href="'+e+'"]')}else{a=t(this);e=a.attr("href")}a.parent().find("a.nav-tab").removeClass("nav-tab-active");a.addClass("nav-tab-active");r.find(".tab").hide();r.find(e).show();if(e=="#dynamic_embed_options"&&i!==false)t("#dynamic_embed_options_post_type").trigger("change");if(e=="#image_button")A="image";if(e=="#text_button")A="text";E=r.find(e).find(".postlist").eq(0);return false}function K(){Z();var e=f.val(),i=j.element.width(),a=Math.round(i/1.6),n=t("<img>",{src:"https://dummy.mailster.co/"+i*e+"x"+a*e+".jpg",alt:j.content,label:j.content,width:i,height:a,border:0,editable:j.content});n[0].onload=function(){n.attr({width:i,height:a}).removeAttr("style");ve()};if(j.element.parent().is("a"))j.element.unwrap();if(!j.element.parent().is("td"))j.element.unwrap();j.element.replaceWith(n);return false}function Q(){if(t(this).is(":checked")){f.val(2);l.addClass("high-dpi")}else{f.val(1);l.removeClass("high-dpi")}}function G(){clearInterval(O);Z();O=setTimeout(function(){var i=l.find("#dynamic_embed_options_post_type").val(),a=l.find("#dynamic_embed_options_content").val(),n=l.find("#dynamic_embed_options_relative").val(),r=l.find(".dynamic_embed_options_taxonomy_wrap"),s=t("#dynamic_rss_url").val(),o={},d=[];t.each(r,function(e){var i=t(this).find("select"),a=[];t.each(i,function(){var e=parseInt(t(this).val(),10);if(e!=-1&&t.inArray(e,a)==-1&&!isNaN(e))a.push(e)});a=a.join(",");if(a)d[e]=a});o={id:e.campaign_id,post_type:i,relative:n,extra:d,content:a,modulename:j.name,expect:j.elements.expects,rss_url:s};if(JSON.stringify(o)===JSON.stringify(z)){Z(false);return}t("#dynamic_embed_options").find("h4.current-match").html("&hellip;");t("#dynamic_embed_options").find("div.current-tag").html("&hellip;");if("rss"==i&&!s){Z(false);return}z=o;e.util.ajax("check_for_posts",o,function(e){Z(false);if(e.success){D=e.pattern;t("#dynamic_embed_options").find("h4.current-match").html(e.title);t("#dynamic_embed_options").find("div.current-tag").text(e.pattern.title+"\n\n"+e.pattern[a])}},function(e,t,i){Z(false)})},500)}function P(t,i,a,n,l){i=i||d.val();a=a||c.val()||Math.round(i/1.6);n=typeof n=="undefined"?m.prop(":checked"):n;l=typeof l=="undefined"?u.prop(":checked"):l;if(/^\{([a-z0-9-_,;:|~]+)\}$/.test(t)){var r=f.val();t=e.ajaxurl+"?action=mailster_image_placeholder&tag="+t.replace("{","").replace("}","")+"&w="+Math.abs(i)+"&h="+Math.abs(a)+"&c="+(n?1:0)+"&o="+(l?1:0)+"&f="+r}return t}function X(e){if(-1!==e.indexOf("?action=mailster_image_placeholder&tag=")){var t=e.match(/&tag=([a-z0-9-_,;:|~]+)&/);return"{"+t[1]+"}"}return false}function Y(e){if((e.keyCode||e.which)!=27&&j)j.element.html(t(this).val())}function Z(e){if(e===false){t("#editbar-ajax-loading").hide();l.find(".buttons").find("button").prop("disabled",false)}else{t("#editbar-ajax-loading").css("display","inline");l.find(".buttons").find("button").prop("disabled",true)}}function ee(){if(j.type=="img"){var i=j.element.is("img");if(g.val()){T={id:null,name:"",src:P(g.val()),width:T.width,height:T.height,asp:T.width/T.height}}if(T){Z();var a=f.val()||1,n=d.val(),s=c.val(),h=m.is(":checked"),x=u.is(":checked"),C=i?"src":"background",q;j.element.attr({"data-id":T.id}).data("id",T.id).addClass("mailster-loading");if(i){j.element.attr({src:T.src,alt:T.name});if(!j.is_percentage){j.element.attr("width",Math.round(n))}if(j.element.attr("height")&&j.element.attr("height")!="auto"){j.element.attr("height",Math.round(s))}if(h){j.element.attr({"data-crop":true}).data("crop",true)}if(x){j.element.attr({"data-original":true}).data("original",true)}}if(T.src){j.element.attr(C,T.src);if(q=j.element.attr("style")){j.element.attr("style",q.replace(/url\("?(.+)"?\)/,"url('"+T.src+"')"))}}e.util.ajax("create_image",{id:T.id,original:x,src:T.src,width:n*a,height:s*a,crop:h},function(t){Z(false);if(t.success){o.attr("src",t.image.url);t.image.width=(t.image.width||T.width)/a;t.image.height=t.image.width/T.asp;t.image.asp=T.asp;T=t.image;T.name=b.val();if(i){j.element.one("load error",function(i){if("error"==i.type){alert(e.util.sprintf(e.l10n.campaigns.invalid_image,t.image.url))}j.element.removeClass("mailster-loading");e.trigger("save")});j.element.attr({alt:T.name});if(!j.is_percentage){j.element.attr("width",Math.round(d.val()))}if(j.element.attr("height")&&j.element.attr("height")!="auto"){j.element.attr("height",Math.round(c.val()))}if(h){j.element.attr({"data-crop":true}).data("crop",true)}if(x){j.element.attr({"data-original":true}).data("original",true)}}else{j.element.removeClass("mailster-loading");var n=j.element.html(),l=n.match(/<modules/),r;if(v.val()){if(l){if(l=n.match(new RegExp("<v:background(.*)</v:background>","s"))){j.element.html(e.util.replace(n,l[0],e.util.replace(l[0],v.val(),T.url)))}}else{j.element.html(e.util.replace(n,v.val(),T.url));j.element.find("single, multi").removeAttr("id")}}}j.element.removeAttr(C).attr(C,T.url)}else{j.element.removeClass("mailster-loading")}b.val("");ve()},function(e,t,i){Z(false)})}else{j.element.attr({alt:b.val()});ve()}if(j.element.parent().is("a"))j.element.unwrap();var N=p.val();if(N)j.element.wrap('<a href="'+N+'"></a>');return false}else if(j.type=="btn"){var N=_.val();if(!N&&!confirm(e.l10n.campaigns.remove_btn))return false;var $=r.find("a.active").find("img").attr("src");if(typeof $=="undefined"){A="text";if(!w.val())w.val(e.l10n.campaigns.read_more)}j.element.removeAttr("tmpbutton");if("image"==A){var a=f.val();var E=new Image;E.onload=function(){if(!j.element.find("img").length){var e=j.element.closest(".textbutton");var i=t('<a href="" editable label="'+j.name+'"><img></a>');e.length?e.replaceWith(i):j.element.replaceWith(i);j.element=i}j.element.find("img").attr({src:$,width:Math.round((E.width||j.element.width())/a),height:Math.round((E.height||j.element.height())/a),alt:k.val()});N?j.element.attr("href",N):j.element.remove();ve()};E.src=$}else{var I=j.element.closest(".textbutton"),O=w.val();if(!I.length){j.element.replaceWith('<table class="textbutton" align="left" role="presentation"><tr><td align="center" width="auto"><a href="'+N+'" editable label="'+O+'">'+O+"</a></td></tr></table>")}else{if(j.element[0]==I[0]){j.element=I.find("a")}j.element.text(O)}if(N){j.element.attr("href",N)}else{j.element.remove();I.remove()}ve()}return false}else if(j.type=="auto"){var z=t("#embedoption-bar").find(".nav-tab-active").data("type"),R=j.element.data("position")||0,W,L=[],S,B;j.element.removeAttr("data-tag data-rss").removeData("tag").removeData("data-rss");if("dynamic"==z){W=l.find("#dynamic_embed_options_content").val();S=l.find("#dynamic_embed_options_post_type").val();B=t("#dynamic_rss_url").val();D.content=D[W];j.element.attr("data-tag",D.tag).data("tag",D.tag);if("rss"==S){j.element.attr("data-rss",B).data("rss",B)}}else{W=t(".embed_options_content:checked").val();j.element.removeAttr("data-tag").removeData("tag")}if(D){if(j.elements.single.length){j.elements.single.each(function(e,i){var a=t(this),n=a.attr("expect")||"title",l=D[n]?D[n]:"";if(l)a.html(l)})}if(j.elements.multi.length){j.elements.multi.each(function(e,i){var a=t(this),n=a.attr("expect")||W,l=D[n]?D[n]:"";if(l)a.html(l)})}if(D.link){if(j.elements.buttons.length){j.elements.buttons.eq(R).attr("href",D.link)}}else{if(j.elements.buttons.parent().length&&j.elements.buttons.parent()[0].nodeName=="TD"){j.elements.buttons.eq(R).closest(".textbutton").remove()}else if(j.elements.buttons.length){if(j.elements.buttons.eq(R).last().find("img").length){j.elements.buttons.remove()}}}if(D.image&&j.elements.images.length){if(!Array.isArray(D.image)){L[R]=D.image}else{L=D.image}D.image=L;Z();j.elements.images.each(function(i,a){if(!D.image[i])return;var n=t(this);var l=f.val();if("static"==z){e.util.ajax("create_image",{id:D.image[i].id,original:u.is(":checked"),width:n.width()*l,height:n.height()*l,crop:n.data("crop")},function(t){if(t.success){Z(false);if(u.is(":checked")){n.attr({"data-original":true}).data("original",true)}if("img"==n.prop("tagName").toLowerCase()){n.attr({"data-id":D.image[i].id,src:t.image.url,width:Math.round(t.image.width/l),alt:D.alt||D.title[i]}).data("id",D.image[i].id);if(n.attr("height")&&n.attr("height")!="auto"){n.attr("height",Math.round(t.image.height/l))}if(n.parent().is("a")){n.unwrap()}if(D.link){n.wrap("<a>");n.parent().attr("href",D.link)}}else{var a=n.attr("background");n.attr({"data-id":D.image[i].id,background:t.image.url}).data("id",D.image[i].id).css("background-image","");j.element.html(e.util.replace(j.element.html(),a,t.image.url));j.element.find("single, multi").removeAttr("id");e.trigger("save");e.trigger("refresh")}}},function(e,t,i){Z(false)});return false}else if("dynamic"==z){var r=n.width(),s=n.data("crop"),o=u.is(":checked"),d=s?n.height():null;if("img"==n.prop("tagName").toLowerCase()){n.removeAttr("data-id").attr({src:P(D.image[i],r,d,s,o),width:r,alt:D.alt||D.title[i]}).removeData("id");if(n.attr("height")){n.attr("height",d||Math.round(r/1.6))}}else{var c=n.attr("background");n.removeAttr("data-id").attr({background:P(D.image[i],r)}).removeData("id").css("background-image","");j.element.html(e.util.replace(j.element.html(),c,P(D.image[i],r,d,s,o)));j.element.find("single, multi").removeAttr("id")}}})}R=R+1>=j.areas.length?0:R+1;j.element.data("position",R);e.$.iframe.contents().find("html").find("img").each(function(){this.onload=function(){e.trigger("refresh")}})}}else if(j.type=="multi"){if(e.util.isTinyMCE&&tinymce.get("mailster-editor")&&!tinymce.get("mailster-editor").isHidden()){var H=tinymce.get("mailster-editor").getContent();H=H.replace('href="http://{','href="{');j.element.html(H)}}else if(j.type=="single"){if(j.conditions){j.aa="<if";t.each(t(".conditinal-area"),function(){j.aa=""})}if(j.element.parent().is("a"))j.element.unwrap();var N=y.val();if(N)j.element.wrap('<a href="'+N+'"></a>')}else if(j.type=="codeview"){var J=M.getValue();j.element.html(J);j.modulebuttons.prependTo(j.element)}ve();return false}function te(){if(j.element.parent().is("a"))j.element.unwrap();if("btn"==j.type){var e=j.element.closest(".textbutton"),t=e.parent();if(!e.length){e=j.element}if(t.is("buttons")&&!t.find(".textbutton").length){t.remove()}else{e.remove()}}else if("img"==j.type&&"img"!=j.tag){j.element.attr("background","")}else{j.element.remove()}ve();return false}function ie(){switch(j.type){case"img":case"btn":if(j.element.is("[tmpbutton]")){j.element.remove()}break;default:j.element.html(j.content);j.element.find("single, multi").removeAttr("id")}ve();return false}function ae(){var e=t(this),i=e.data("link");r.find(".btnsrc").removeClass("active");e.addClass("active");k.val(e.attr("title"));if(i){var a;_.val(i);if((a=(i+"").indexOf("USERNAME",0))!=-1){_.focus();selectRange(_[0],a,a+8)}}return false}function ne(){t(this).toggleClass("zoom")}function le(e,i){var a=i||t(this),n=a.data("id"),l=a.data("name"),s=a.data("src");if(!n)return;T={id:n,name:l,src:s};Z();r.find("li.selected").removeClass("selected");a.addClass("selected");if(j.element.data("id")==n){b.val(j.element.attr("alt"))}else if(j.element.attr("alt")!=l){b.val(l)}g.val("");o.attr("src","").on("load",function(){o.off("load");j.width=o.width();j.height=o.height();j.asp=a.data("asp")||j.width/j.height;T.asp=j.asp;Z(false);if(!m.is(":checked"))c.val(Math.round(d.val()/j.asp));re()}).attr("src",s);return T}function re(){var e=Math.round(.5*(j.height-j.width*(c.val()/d.val())))||0,t=parseInt(f.val(),10);o.css({clip:"rect("+e+"px,"+j.width*t+"px,"+(j.height*t-e)+"px,0px)","margin-top":-1*e+"px"})}function se(){var i=t(this),a=i.data("id"),n=i.data("name"),l=i.data("link"),s=i.data("thumbid");if(j.type=="btn"){_.val(l);k.val(n);r.find("li.selected").removeClass("selected");i.addClass("selected")}else if(j.type=="single"){y.val(l);r.find("li.selected").removeClass("selected");i.addClass("selected")}else{Z();e.util.ajax("get_post",{id:a,expect:j.elements.expects},function(t){Z(false);r.find("li.selected").removeClass("selected");i.addClass("selected");if(t.success){D=t.pattern;r.find(".editbarinfo").html(e.l10n.campaigns.curr_selected+": <span>"+D.title+"</span>")}},function(e,t,i){Z(false);r.find("li.selected").removeClass("selected")})}return false}function oe(i){j=i;var a=i.element,n=a.closest("module"),s=A!="img"?i.offset.top:0,C=i.name||"",A=i.type,D=e.util.trim(a.html()),I=a.find("if"),O,z=j.element.data("position")||0,R,W,H,J=1;r=l.find("div.type."+A);l.addClass("current-"+A);j.width=a.width();j.height=a.height();j.asp=j.width/j.height;j.crop=a.data("crop")?a.data("crop"):false;j.tag=a.prop("tagName").toLowerCase();j.is_percentage=a.attr("width")&&a.attr("width").indexOf("%")!==-1;j.content=D;N=j.element.data("tag");L="";e.trigger("selectModule",n);if(I.length){O={if:null,elseif:[],else:null,total:0};O=[];l.addClass("has-conditions");R=r.find(".conditinal-area");W=l.find(".conditions").eq(0);W.clone().prependTo(R);t.each(I.find("elseif"),function(){var e=t(this),i=e.html();O.push({el:e,html:i,field:e.attr("field"),operator:e.attr("operator"),value:e.attr("value")});e.detach();R.clone().val(i).insertAfter(R)});t.each(I.find("else"),function(){var e=t(this),i=e.html();O.push({el:e,html:i});e.detach();R.clone().val(i).insertAfter(R)});O.unshift({el:I,html:I.html(),field:I.attr("field"),operator:I.attr("operator"),value:I.attr("value")})}else{l.removeClass("has-conditions")}j.conditions=O;if(A=="img"){u.prop("checked",j.original);m.prop("checked",j.crop).parent()[j.crop?"addClass":"removeClass"]("not-cropped");L=e.util.trim(B.val());f.val(1);e.util.getRealDimensions(a,function(e,t,i){var t=i>=1.5;f.val(i);h.prop("checked",t);t?l.addClass("high-dpi"):l.removeClass("high-dpi");J=i})}else if(A=="btn"){if(a.find("img").length){t("#button-type-bar").find("a").eq(1).trigger("click");var V=a.find("img").attr("src");if(x.length){var U=l.find("img[src='"+V+"']");if(U.length){l.find("ul.buttons").hide();var K=U.parent().parent().parent();l.find('a[href="#'+K.attr("id").substr(4)+'"]').trigger("click")}else{t.each(l.find(".button-nav"),function(){t(this).find(".nav-tab").eq(0).trigger("click")})}}w.val(a.find("img").attr("alt"));e.util.getRealDimensions(a.find("img"),function(e,t,i){var t=i>=1.5;f.val(i);h.prop("checked",t);t?l.addClass("high-dpi"):l.removeClass("high-dpi");J=i})}else{t("#button-type-bar").find("a").eq(0).trigger("click");w.val(e.util.trim(a.text())).focus().select();_.val(j.element.attr("href"));l.find("ul.buttons").hide()}}else if(A=="auto"){F("#"+(N?"dynamic":"static")+"_embed_options",true);L=e.util.trim(S.val());if(N){var Q=N.substr(1,N.length-2).split(":"),G=Q[1].split(";"),P=G.shift(),Y=G.length?G:null;N={post_type:Q[0],relative:P,terms:Y};t("#dynamic_embed_options_post_type").val(N.post_type).trigger("change");t("#dynamic_embed_options_relative").val(N.relative).trigger("change")}else{}}else if(A=="codeview"){var ee=r.find("textarea"),te=a.clone();j.modulebuttons=te.find("modulebuttons");te.find("modulebuttons").remove();te.find("single, multi").removeAttr("contenteditable spellcheck id dir style class");var ie=e.util.trim(te.html().replace(/\u200c/g,"&zwnj;").replace(/\u200d/g,"&zwj;"));ee.show().html(ie)}H=e.$.template.offset().top+(j.offset.top-e.$.window.height()/2+j.height/2);H=Math.max(e.$.template.offset().top-200,H);e.util.scroll(H,function(){l.find("h4.editbar-title").html(C);l.find("div.type").hide();l.find("div."+A).show();if(n.data("rss"))t("#dynamic_rss_url").val(n.data("rss"));var i=e.util.top()+e.$.window.height()/2-e.$.template.offset().top-l.height()/2;l.css({top:i});Z();if(A=="single"){if(O){t.each(O,function(e,t){var i=r.find(".conditinal-area").eq(e);i.find("select.condition-fields").val(t.field);i.find("select.condition-operators").val(t.operator);i.find("input.condition-value").val(t.value);i.find("input.input").val(t.html)})}else{var s=D.replace(/&amp;/g,"&");y.val("");if(j.element.parent().is("a")){var f=j.element.parent().attr("href");y.val(f!="#"?f:"");fe()}else if(j.element.find("a").length){var h=j.element.find("a");if(s==h.text()){var f=h.attr("href");s=h.text();y.val(f!="#"?f:"")}}r.find("input").eq(0).val(e.util.trim(s))}}else if(A=="img"){var u=parseInt(a[0].style.maxWidth,10)||a.parent().width()||a.width()||null;var w=parseInt(a[0].style.maxHeight,10)||a.parent().height()||a.height()||null;var x=a.attr("src")||a.attr("background");var N=X(x)||"";if(a.parent().is("a")){p.val(a.parent().attr("href").replace("%7B","{").replace("%7D","}"))}else{p.val("")}b.val(a.attr("alt"));g.val(N);v.val(x);a.data("id",a.attr("data-id"));t(".imageurl-popup").toggle(!!N);o.removeAttr("src").attr("src",x);$="attachment";E=r.find(".imagelist");T={id:a.data("id"),src:x,width:a.width()*J,height:a.height()*J};T.asp=T.width/T.height;de();re()}else if(A=="btn"){k.val(a.find("img").attr("alt"));if(a.attr("href"))_.val(a.attr("href").replace("%7B","{").replace("%7D","}"));$="link";E=r.find(".postlist").eq(0);de();t.each(r.find(".buttons img"),function(){var e=t(this);e.css("background-color",a.css("background-color"));e.attr("src")==V?e.parent().addClass("active"):e.parent().removeClass("active")})}else if(A=="auto"){$="post";E=r.find(".postlist").eq(0);de();j.areas=j.element.find("[area]");if(!j.areas.length){j.areas=j.element}j.elements={single:j.areas.eq(z).find("single"),multi:j.areas.eq(z).find("multi"),buttons:j.areas.eq(z).find("a[editable]"),images:j.areas.eq(z).find("img[editable], td[background], th[background]"),expects:j.areas.eq(z).find("[expect]").map(function(){return t(this).attr("expect")}).toArray()};if(j.areas.length>1){l.find(".editbarposition").html(e.util.sprintf(e.l10n.campaigns.for_area,"#"+(z+1))).show()}else{l.find(".editbarposition").hide()}}else if(A=="codeview"){if(M){M.clearHistory();M.setValue("");r.find(".CodeMirror").remove()}}l.show(0,function(){if(A=="single"){l.find("input").focus().select()}else if(A=="img"){d.val(j.width);c.val(j.height);m.prop("checked",j.crop)}else if(A=="btn"){d.val(u);c.val(w)}else if(A=="multi"){t("#mailster-editor").val(D);if(e.util.isTinyMCE&&tinymce.get("mailster-editor")){tinymce.get("mailster-editor").setContent(D);tinymce.execCommand("mceFocus",false,"mailster-editor")}}else if(A=="codeview"){M=e.util.CodeMirror.fromTextArea(ee.get(0),q)}});Z(false)},100)}function de(i,a){var n=t("#post_type_select").find("input:checked").serialize(),l={type:$,posttypes:n,search:L,imagetype:H.filter(":checked").val(),offset:0};if($=="attachment"){l.id=T.id}E.empty();Z();e.util.ajax("get_post_list",l,function(e){Z(false);if(e.success){I=e.itemcount;he(e.html,true);a&&a()}},function(e,t,i){Z(false)})}function ce(){var i=t(this),a=i.data("offset"),n=i.data("type");Z();var l=t("#post_type_select").find("input:checked").serialize();e.util.ajax("get_post_list",{type:n,posttypes:l,search:L,imagetype:H.filter(":checked").val(),offset:a,itemcount:I},function(e){Z(false);if(e.success){I=e.itemcount;i.remove();he(e.html,false)}},function(e,t,i){Z(false)});return false}function me(){var i=t(this),a=e.util.trim("attachment"==$?B.val():S.val());if(!i.is(":checked")&&L==a){return false}L=a;clearTimeout(R);R=setTimeout(function(){de()},500)}function fe(){t("#single-link").slideDown(200);y.focus().select();$="link";E=r.find(".postlist").eq(0);de();return false}function he(e,t,i){if(!i)i=E;if(t)i.empty();if(!i.html())i.html("<ul></ul>");i.find("ul").append(e)}function ue(){t(".imageurl-popup").toggle();if(!g.val()&&T.src.indexOf(location.origin)==-1&&T.src.indexOf("dummy.mailster.co")==-1){g.val(T.src)}g.focus().select();return false}function pe(){if(!wp.media.frames.mailster_editbar){wp.media.frames.mailster_editbar=wp.media({title:e.l10n.campaigns.select_image,library:{type:"image"},multiple:false});wp.media.frames.mailster_editbar.on("select",function(){var e=wp.media.frames.mailster_editbar.state().get("selection").first().toJSON(),i=t("img").data({id:e.id,name:e.name,src:e.url});de(null,function(){le(null,i)})})}wp.media.frames.mailster_editbar.open()}function ge(t){clearTimeout(timeout);timeout=setTimeout(function(){if(!t)return;var i=e.util.trim(t.save());j.element.html(i)},100)}function ve(){l.removeClass("current-"+j.type).hide();Z(false);t("#single-link").hide();e.trigger("refresh");e.trigger("save");return false}n.save=ee;n.open=oe;n.cancel=ie;e.editbar=n;return e}(mailster||{},jQuery,window,document);