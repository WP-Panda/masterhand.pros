mailster=function(e,o,t,a){"use strict";var i,n={mode:{name:"htmlmixed",scriptTypes:[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]},tabMode:"indent",lineNumbers:true,viewportMargin:Infinity,autofocus:true};e.optionbar={};e.optionbar.undos=[];e.optionbar.currentUndo=0;e.optionbar.undo=function(){if(e.optionbar.currentUndo){e.optionbar.currentUndo--;e.editor.setContent(e.optionbar.undos[e.optionbar.currentUndo],100,false);e.$.optionbar.find("a.redo").removeClass("disabled");if(!e.optionbar.currentUndo){o(this).addClass("disabled")}}};e.optionbar.redo=function(){var t=e.optionbar.undos.length;if(e.optionbar.currentUndo<t-1){e.optionbar.currentUndo++;e.editor.setContent(e.optionbar.undos[e.optionbar.currentUndo],100,false);e.$.optionbar.find("a.undo").removeClass("disabled");if(e.optionbar.currentUndo>=t-1){o(this).addClass("disabled")}}};e.optionbar.removeModules=function(){if(confirm(e.l10n.campaigns.remove_all_modules)){var o=e.$.iframe.contents().find("modules");var t=o.find("module");o.slideUp(function(){t.remove();o.html("").show();e.trigger("refresh");e.trigger("save")})}};e.optionbar.codeView=function(){var t;if(e.$.iframe.is(":visible")){t=e.editor.getStructure(e.editor.getFrameContent());e.$.optionbar.find("a.code").addClass("loading");e.trigger("disable");e.util.ajax("toggle_codeview",{bodyattributes:t.parts[2],content:t.content,head:t.head},function(o){e.$.optionbar.find("a.code").addClass("active").removeClass("loading");e.$.html.hide();e.$.content.val(o.content);e.$.optionbar.find("a").not("a.redo, a.undo, a.code").addClass("disabled");i=e.util.CodeMirror.fromTextArea(e.$.content.get(0),n)},function(o,t,a){e.$.optionbar.find("a.code").addClass("active").removeClass("loading");e.trigger("enable")})}else{t=e.editor.getStructure(i.getValue());i.clearHistory();e.$.optionbar.find("a.code").addClass("loading");e.trigger("disable");e.util.ajax("toggle_codeview",{bodyattributes:t.parts[2],content:t.content,head:t.head},function(t){e.editor.setContent(t.content,100,true,t.style);e.$.html.show();e.$.content.hide();o(".CodeMirror").remove();e.$.optionbar.find("a.code").removeClass("active").removeClass("loading");e.$.optionbar.find("a").not("a.redo, a.undo, a.code").removeClass("disabled");e.trigger("enable")},function(o,t,a){e.$.optionbar.find("a.code").addClass("active").removeClass("loading");e.trigger("enable")})}return false};e.optionbar.plainText=function(){if(e.$.iframe.is(":visible")){e.$.optionbar.find("a.plaintext").addClass("active");e.$.html.hide();e.$.excerpt.show();e.$.plaintext.show();e.$.optionbar.find("a").not("a.redo, a.undo, a.plaintext, a.preview").addClass("disabled")}else{e.$.html.show();e.$.plaintext.hide();e.$.optionbar.find("a.plaintext").removeClass("active");e.$.optionbar.find("a").not("a.redo, a.undo, a.plaintext, a.preview").removeClass("disabled");e.trigger("refresh")}};e.optionbar.openSaveDialog=function(){tb_show(e.l10n.campaigns.save_template,"#TB_inline?x=1&width=480&height=320&inlineId=mailster_template_save",null);o("#new_template_name").focus().select()};e.optionbar.preview=function(){if(e.$.optionbar.find("a.preview").is(".loading")){return false}e.trigger("save");e.$.optionbar.find("a.preview").addClass("loading");e.util.ajax("set_preview",{id:e.campaign_id,content:e.editor.getContent(),head:e.$.head.val(),issue:o("#mailster_autoresponder_issue").val(),subject:e.details.$.subject.val(),preheader:e.details.$.preheader.val()},function(o){e.$.optionbar.find("a.preview").removeClass("loading");e.thickbox.$.preview.attr("src",ajaxurl+"?action=mailster_get_preview&hash="+o.hash+"&_wpnonce="+o.nonce);tb_show(e.$.title.val()?e.util.sprintf(e.l10n.campaigns.preview_for,'"'+e.$.title.val()+'"'):e.l10n.campaigns.preview,"#TB_inline?hash="+o.hash+"&_wpnonce="+o.nonce+"&width="+Math.min(1200,e.$.window.width()-50)+"&height="+(e.$.window.height()-100)+"&inlineId=mailster_campaign_preview",null)},function(o,t,a){e.$.optionbar.find("a.preview").removeClass("loading")})};e.optionbar.dfw=function(o){if(o.type=="mouseout"&&!/DIV|H3/.test(o.target.nodeName)){return}if(!e.$.body.hasClass("focus-on")){e.$.body.removeClass("focus-off").addClass("focus-on");e.$.wpbody.on("mouseleave.dfw",e.optionbar.dfw);e.$.optionbar.find("a.dfw").addClass("active");if(e.$.window.scrollTop()<r()){e.util.scroll(r()-80)}}else{e.$.body.removeClass("focus-on").addClass("focus-off");e.$.wpbody.off("mouseleave",e.optionbar.dfw);e.$.optionbar.find("a.dfw").removeClass("active")}};e.editable&&e.$.document.on("click","button.save-template",c).on("click","button.save-template-cancel",tb_remove);e.editable&&e.$.optionbar.on("click","a",false).on("click","a.save-template",e.optionbar.openSaveDialog).on("click","a.clear-modules",e.optionbar.removeModules).on("click","a.preview",e.optionbar.preview).on("click","a.undo",e.optionbar.undo).on("click","a.redo",e.optionbar.redo).on("click","a.code",e.optionbar.codeView).on("click","a.plaintext",e.optionbar.plainText).on("click","a.dfw",e.optionbar.dfw).on("click","a.template",l).on("click","a.file",s);e.editable&&e.$.window.on("resize.optionbar",function(){e.$.window.trigger("scroll.optionbar")});e.editable&&e.events.push("editorLoaded",function(){e.optionbar.undos.push(e.editor.getFrameContent())});o(".meta-box-sortables").on("sortstop",function(o,t){e.$.window.trigger("resize.optionbar")});function r(){if(!e.dom.template)return 0;return e.$.template.offset().top}function d(){var o=e.util.top();if(o<r()||o>r()+e.$.template.height()-120){if(/fixed-optionbar/.test(e.dom.body.className)){e.$.body.removeClass("fixed-optionbar");e.$.optionbar.width("auto")}}else{if(!/fixed-optionbar/.test(e.dom.body.className)){e.$.body.addClass("fixed-optionbar");e.$.optionbar.width(e.$.template.width()-22)}}}function l(e){var t=o(this);t.parent().find("ul").eq(0).slideToggle(100)}function s(){t.onbeforeunload=null;t.location=this.href}function c(){e.trigger("disable");var a=o("#new_template_name").val();if(!a){return false}e.trigger("save");var i=o("#new_template-ajax-loading").css("display","inline"),n=o("#new_template_modules").is(":checked"),r=o("#new_template_active_modules").is(":checked"),d=o("#new_template_saveas_dropdown").val(),l=!!parseInt(o('input[name="new_template_overwrite"]:checked').val(),10),s=e.editor.getContent();e.util.ajax("create_new_template",{name:a,modules:n,activemodules:r,overwrite:l?d:false,template:o("#mailster_template_name").val(),content:s,head:e.$.head.val()},function(e){i.hide();if(e.success){if(t.wp){t.wp=null}t.onbeforeunload=null;t.location=e.url}else{alert(e.msg)}},function(e,o,t){i.hide()});return false}return e}(mailster||{},jQuery,window,document);